{"version":3,"sources":["../../../../src/Core/Scheduler/Providers/BuildingBox_Provider.js"],"names":["THREE","BuildingBox_Provider","options","WFS_Provider","geometry","geometryRoof","pivot","roadOn","rtcOn","prototype","constructor","url","longitude","latitude","radius","bottomLeft","Vector2","topRight","x","y","getData","bbox","altitude","then","data","generateMesh","elements","roofGeometry","Geometry","_geometry","features","altitude_ground","feature","hauteur","properties","z_min","polygon","coordinates","arrPoint2D","length","j","pt2DTab","p1","Vector3","parseFloat","coordCarto1","z","coordCarto2","pgeo1","as","xyz","pgeo2","vector3_1","vector3_2","push","vertices","k","l","faces","Face3","ll","triangles","w","pt1","pt2","pt3","c1","EPSG_4326","c2","c3","face","addRoad","computeFaceNormals","firstPos","clone","vertice","sub","altitude_road","ratio","roadWidth","east","west","roadHeight","north","south","pos","coordCarto3","coordCarto4","pgeo3","pgeo4","len"],"mappings":"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","file":"BuildingBox_Provider.js","sourcesContent":["/*\n * To change this license header, choose License Headers in Project Properties.\n * To change this template file, choose Tools | Templates\n * and open the template in the editor.\n */\n\n\n/**\n * Generated On: 2015-10-5\n * Class: WMTS_Provider\n * Description: Fournisseur de données à travers un flux WMTS\n */\n\n\n// TODO , will use WFS_Provider\nimport * as THREE from 'three';\nimport Earcut from 'earcut';\nimport Provider from './Provider';\nimport WFS_Provider from './WFS_Provider';\nimport Coordinates, { C } from '../../Geographic/Coordinates';\n\nfunction BuildingBox_Provider(options) {\n    // Constructor\n\n    // Provider.call( this,new IoDriver_XBIL());\n    // this.cache         = CacheRessource();\n    this.WFS_Provider = new WFS_Provider(options);\n    this.geometry = null;\n    this.geometryRoof = null;\n    this.pivot = null;\n    this.roadOn = true;\n    this.rtcOn = true;\n}\n\nBuildingBox_Provider.prototype = Object.create(Provider.prototype);\nBuildingBox_Provider.prototype.constructor = BuildingBox_Provider;\n\n\n/**\n * Return url wmts MNT\n * @param {number} longitude\n * @param {number} latitude\n * @param {number} radius\n * @returns {string}\n */\nBuildingBox_Provider.prototype.url = function url(longitude, latitude, radius) {\n    // var key    = \"wmybzw30d6zg563hjlq8eeqb\";\n    // var key    = coWMTS.zoom > 11 ? \"va5orxd0pgzvq3jxutqfuy0b\" : \"wmybzw30d6zg563hjlq8eeqb\"; // clef pro va5orxd0pgzvq3jxutqfuy0b\n\n    var key = '72hpsel8j8nhb5qgdh07gcyp';\n\n    // var layer  = \"BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie\"\n    var serviceVersionRequestLayer = 'service=WFS&version=2.0.0&REQUEST=GetFeature&typeName=BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie';\n\n    var bottomLeft = new THREE.Vector2(longitude - radius, latitude - radius);\n    var topRight = new THREE.Vector2(longitude + radius, latitude + radius);\n\n\n    var url = `http://wxs.ign.fr/${key}/geoportail/wfs?${serviceVersionRequestLayer\n        }&bbox=${bottomLeft.x},${bottomLeft.y},${topRight.x\n        },${topRight.y},epsg:4326&outputFormat=json`;\n\n    return url;\n};\n\nBuildingBox_Provider.prototype.getData = function getData(bbox, altitude) {\n    return this.WFS_Provider.getData(bbox).then((data) => {\n        this.generateMesh(data, bbox, altitude); // console.log(data);\n        return this.geometry;\n    });\n};\n\nBuildingBox_Provider.prototype.generateMesh = function generateMesh(elements, bbox, altitude) {\n    var roofGeometry = new THREE.Geometry(); // for the roof\n    var _geometry = new THREE.Geometry(); // for the walls\n    var geometry = new THREE.Geometry(); // for the roof\n    var suppHeight = 10; // So we don't cut the roof\n    var features = elements.features;\n    var altitude_ground = altitude - 1.5; // 35;  // truck height\n\n    for (const feature of features) {\n        const hauteur = (feature.properties.hauteur + suppHeight) || 0;\n        const z_min = altitude_ground; // features[r].properties.z_min;  // altitude_ground // force altitude ground\n        const polygon = feature.geometry.coordinates[0][0];\n\n        const arrPoint2D = [];\n        if (polygon.length > 2) {\n            // VERTICES\n            for (let j = 0; j < polygon.length - 1; ++j) {\n                const pt2DTab = polygon[j]; // .split(' ');\n                const p1 = new THREE.Vector3(parseFloat(pt2DTab[0]), 0, parseFloat(pt2DTab[1]));\n\n                const coordCarto1 = new Coordinates('EPSG:4326', p1.x, p1.z, z_min);\n                const coordCarto2 = new Coordinates('EPSG:4326', p1.x, p1.z, z_min + hauteur); // + Math.random(1000) );\n                const pgeo1 = coordCarto1.as('EPSG:4978').xyz();\n                const pgeo2 = coordCarto2.as('EPSG:4978').xyz();\n\n                const vector3_1 = new THREE.Vector3(pgeo1.x, pgeo1.y, pgeo1.z); // - x temporary, bug\n                const vector3_2 = new THREE.Vector3(pgeo2.x, pgeo2.y, pgeo2.z);\n\n\n                arrPoint2D.push(p1.z, p1.x);\n                _geometry.vertices.push(vector3_1, vector3_2);\n            }\n\n            // FACES\n            // indice of the first point of the polygon 3D\n            for (let k = _geometry.vertices.length - ((polygon.length - 1) * 2); k < _geometry.vertices.length; k += 2) {\n                let l = k; // % (pts2DTab.length);\n                if (l > _geometry.vertices.length - 4) {\n                    l = _geometry.vertices.length - ((polygon.length - 1) * 2);\n                }\n                _geometry.faces.push(new THREE.Face3(l, l + 1, l + 3));\n                _geometry.faces.push(new THREE.Face3(l, l + 3, l + 2));\n            }\n\n            const ll = _geometry.vertices.length - ((polygon.length - 1) * 2);\n            _geometry.faces.push(new THREE.Face3(ll, ll + 1, _geometry.vertices.length - 1));\n            _geometry.faces.push(new THREE.Face3(ll, _geometry.vertices.length - 1, _geometry.vertices.length - 2));\n        }\n\n        //* *************** ROOF ****************************\n\n        var triangles = Earcut(arrPoint2D);\n        for (let w = 0; w < triangles.length; w += 3) {\n            const pt1 = new THREE.Vector2(arrPoint2D[triangles[w] * 2], arrPoint2D[triangles[w] * 2 + 1]);\n            const pt2 = new THREE.Vector2(arrPoint2D[triangles[w + 1] * 2], arrPoint2D[triangles[w + 1] * 2 + 1]);\n            const pt3 = new THREE.Vector2(arrPoint2D[triangles[w + 2] * 2], arrPoint2D[triangles[w + 2] * 2 + 1]);\n            const c1 = new C.EPSG_4326(pt1.x, pt1.y, z_min + hauteur);\n            const c2 = new C.EPSG_4326(pt2.x, pt2.y, z_min + hauteur);\n            const c3 = new C.EPSG_4326(pt3.x, pt3.y, z_min + hauteur);\n\n            roofGeometry.vertices.push(c1.as('EPSG:4978').xyz());\n            roofGeometry.vertices.push(c2.as('EPSG:4978').xyz());\n            roofGeometry.vertices.push(c3.as('EPSG:4978').xyz());\n\n            var face = new THREE.Face3(geometry.vertices.length - 3,\n                                     geometry.vertices.length - 2,\n                                     geometry.vertices.length - 1);\n            geometry.faces.push(face);\n        }\n    }\n\n    if (this.roadOn) {\n        this.addRoad(_geometry, bbox, altitude_ground);\n    }\n\n    _geometry.computeFaceNormals(); // WARNING : VERY IMPORTANT WHILE WORKING WITH RAY CASTING ON CUSTOM MESH\n    geometry.computeFaceNormals();\n\n    /*\n        var matLambert = new THREE.MeshBasicMaterial({color: 0xffffff, transparent: true, opacity: 0.8});\n        var _currentMeshForRoof  = new THREE.Mesh(_geometry, matLambert);// //geometryClickToGo,mat);\n        gfxEngine().add3DScene(_currentMeshForRoof);\n    */\n\n    // Test if we return brute geometry or if we use local pivot (for useRTC)\n    var firstPos = new THREE.Vector3();\n    if (this.rtcOn) {\n        firstPos = _geometry.vertices[0].clone();\n        // create pivot from 1st pos vertex\n        for (const vertice of _geometry.vertices) {\n            vertice.sub(firstPos);\n        }\n        for (const vertice of geometry.vertices) {\n            vertice.sub(firstPos);\n        }\n    }\n\n    this.geometry = _geometry;\n    this.pivot = firstPos;\n    this.geometryRoof = geometry;\n\n    return {\n        geometry: _geometry,\n        pivot: firstPos,\n        geometryRoof: geometry,\n    };\n};\n\n\nBuildingBox_Provider.prototype.addRoad = function addRoad(geometry, bbox, altitude_road) {\n    // Version using SIMPLE PLANE ROAD for Click and Go\n    var ratio = 0.2;\n    var roadWidth = (bbox.east() - bbox.west()) * ratio;\n    var roadHeight = (bbox.north() - bbox.south()) * ratio;\n    var pos = new THREE.Vector3((bbox.south() + bbox.north()) / 2,\n        altitude_road, (bbox.west() + bbox.east()) / 2); // 48.8505774,  altitude_sol, 2.3348124);\n\n    var coordCarto1 = new Coordinates('EPSG:4326', pos.x - roadWidth, pos.z - roadHeight, altitude_road);\n    var coordCarto2 = new Coordinates('EPSG:4326', pos.x - roadWidth, pos.z + roadHeight, altitude_road);\n    var coordCarto3 = new Coordinates('EPSG:4326', pos.x + roadWidth, pos.z + roadHeight, altitude_road);\n    var coordCarto4 = new Coordinates('EPSG:4326', pos.x + roadWidth, pos.z - roadHeight, altitude_road);\n\n    var pgeo1 = coordCarto1.as('EPSG:4978').xyz();\n    var pgeo2 = coordCarto2.as('EPSG:4978').xyz();\n    var pgeo3 = coordCarto3.as('EPSG:4978').xyz();\n    var pgeo4 = coordCarto4.as('EPSG:4978').xyz();\n\n    geometry.vertices.push(new THREE.Vector3(pgeo1.x, pgeo1.y, pgeo1.z));\n    geometry.vertices.push(new THREE.Vector3(pgeo2.x, pgeo2.y, pgeo2.z));\n    geometry.vertices.push(new THREE.Vector3(pgeo3.x, pgeo3.y, pgeo3.z));\n    geometry.vertices.push(new THREE.Vector3(pgeo4.x, pgeo4.y, pgeo4.z));\n\n    var len = geometry.vertices.length;\n    geometry.faces.push(new THREE.Face3(len - 4, len - 3, len - 2));\n    geometry.faces.push(new THREE.Face3(len - 4, len - 2, len - 1));\n};\n\n\nexport default BuildingBox_Provider;\n"]}