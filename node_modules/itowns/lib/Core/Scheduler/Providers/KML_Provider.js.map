{"version":3,"sources":["../../../../src/Core/Scheduler/Providers/KML_Provider.js"],"names":["THREE","KML_Provider","ellipsoid","kmzLoader","cache","prototype","constructor","loadKMZ","longitude","latitude","getUrlCollada","then","result","undefined","scene","children","child","coorCarto","position","cartographicToCartesian","altitude","normal","geodeticSurfaceNormalCartographic","quaternion","Quaternion","setFromAxisAngle","Vector3","Math","PI","lookAt","addVectors","multiply","copy","updateMatrix","visible","changeMaterial","object3D","material","MultiMaterial","MeshBasicMaterial","color","materials","traverse","parseKML","urlFile","networkOptions","url","xml","NetworkLink","getElementsByTagName","i","length","coords","childNodes","nodeValue","href","replace","toLowerCase","substr","url_kmz","p","load","url_href_1"],"mappings":"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mD,oCACM,0BADN,oDAAJ;;;AAKA,eAAO,OAAKnB,QAAL,CAAcmB,UAAd,EAA0BtD,SAA1B,EAAqCC,QAArC,CAAP;AACH,KATM,CAAP;AAUH,CAXD;;kBAaeR,Y;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA","file":"KML_Provider.js","sourcesContent":["import * as THREE from 'three';\nimport Provider from './Provider';\nimport Fetcher from './Fetcher';\nimport KMZLoader from '../../../Renderer/ThreeExtended/KMZLoader';\n\nfunction KML_Provider(ellipsoid) {\n    this.ellipsoid = ellipsoid;\n    this.kmzLoader = new KMZLoader();\n    this.cache = new Map();\n}\n\nKML_Provider.prototype = Object.create(Provider.prototype);\n\nKML_Provider.prototype.constructor = KML_Provider;\n\nKML_Provider.prototype.loadKMZ = function loadKMZ(longitude, latitude) {\n    return this.getUrlCollada(longitude, latitude).then((result) => {\n        if (result === undefined)\n            { return undefined; }\n\n        if (result.scene.children[0]) {\n            var child = result.scene.children[0];\n            var coorCarto = result.coorCarto;\n\n            var position = this.ellipsoid.cartographicToCartesian(coorCarto);\n            coorCarto.altitude = 0;\n            var normal = this.ellipsoid.geodeticSurfaceNormalCartographic(coorCarto);\n\n            var quaternion = new THREE.Quaternion();\n            quaternion.setFromAxisAngle(new THREE.Vector3(1, 0, 0), Math.PI / 2);\n\n            child.lookAt(new THREE.Vector3().addVectors(position, normal));\n            child.quaternion.multiply(quaternion);\n            child.position.copy(position);\n\n            child.updateMatrix();\n            child.visible = false;\n\n            var changeMaterial = function changeMaterial(object3D) {\n                if (object3D.material instanceof THREE.MultiMaterial) {\n                    object3D.material = new THREE.MeshBasicMaterial({ color: object3D.material.materials[0].color });\n                } else if (object3D.material)\n                    { object3D.material = new THREE.MeshBasicMaterial({ color: object3D.material.color }); }\n            };\n\n\n            child.traverse(changeMaterial);\n\n            return child;\n        }\n        return undefined;\n    });\n};\n\nKML_Provider.prototype.parseKML = function parseKML(urlFile, longitude, latitude, networkOptions) {\n    var north = latitude;\n    var south = latitude;\n    var east = longitude;\n    var west = longitude;\n    var key = 'va5orxd0pgzvq3jxutqfuy0b';\n    var url = `http://wxs.ign.fr/${key}/vecteurtuile3d/BATI3D/FXX/`;\n    return Fetcher.xml(urlFile, networkOptions).then((result) => {\n        var NetworkLink = [];\n        NetworkLink = result.getElementsByTagName('NetworkLink');\n\n        for (var i = 0; i < NetworkLink.length; i++) {\n            var coords = [];\n            coords[0] = NetworkLink[i].getElementsByTagName('north')[0].childNodes[0].nodeValue;\n            coords[1] = NetworkLink[i].getElementsByTagName('south')[0].childNodes[0].nodeValue;\n            coords[2] = NetworkLink[i].getElementsByTagName('east')[0].childNodes[0].nodeValue;\n            coords[3] = NetworkLink[i].getElementsByTagName('west')[0].childNodes[0].nodeValue;\n\n\n            if (north < coords[0] && south > coords[1] && east < coords[2] && west > coords[3]) {\n                var href = [];\n                href[i] = `${url}TREE/${NetworkLink[i].getElementsByTagName('href')[0].childNodes[0].nodeValue.replace('../', '')}`;\n\n                if (href[i].toLowerCase().substr(-4) === '.kml') {\n                    return this.parseKML(href[i], longitude, latitude);\n                }\n                // Next level : Get the next KMZ actual position's coords\n                else if (href[i].toLowerCase().substr(-4) === '.kmz') {\n                    var url_kmz = url + NetworkLink[i].getElementsByTagName('href')[0].childNodes[0].nodeValue.replace('../../', '');\n                    // url_kmz = \"http://localhost:8383/kmz/BT_000092.kmz\";\n\n                    var p = this.cache[url_kmz];\n                    if (!p) {\n                        p = this.kmzLoader.load(url_kmz);\n                        this.cache[url_kmz] = p;\n                    }\n                    return p;\n                }\n            }\n        }\n    });\n};\n\n\nKML_Provider.prototype.getUrlCollada = function getUrlCollada(longitude, latitude) {\n    return Fetcher.xml('http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/BU.Building.kml').then(() => {\n        // get href's node value\n        // var kml_0 = result_0.getElementsByTagName(\"href\");\n        var url_href_1;\n        var key = 'va5orxd0pgzvq3jxutqfuy0b';\n\n        url_href_1 = `http://wxs.ign.fr/${key}/vecteurtuile3d/BATI3D/FXX/TREE/0/0_000_000.kml`;\n\n        return this.parseKML(url_href_1, longitude, latitude);\n    });\n};\n\nexport default KML_Provider;\n// If France\n//                if (url_href_1[i] === 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/FXX/TREE/0/0_000_000.kml'){\n//                    //this.ParseKML(url_href_1[i]);\n//                    //console.log(\"wesh\");\n//                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n//                    {\n//                        var kml_1 = [];\n//                        kml_1 = result_1.getElementsByTagName(\"href\");\n//                        //console.log(kml_1.length);\n//\n//                        for (j=0; j<kml_1.length; j++){\n//\n//                            var url_href_2 = [];\n//                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'FXX' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n//                            //console.log(url_href_2[j]);\n//\n//                            //get tile's coords\n//                            var coords_2 = [];\n//                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n//                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n//                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n//                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n//\n//                            //get min and max LodPixel of each tile\n//                            /*var min_max_2 = [];\n//                            min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n//                            min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n//                            console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);*/\n//\n//                            //Next level : Get the next KML actual position's coords\n//                            //this.ParseKML(url_href_2[j]/*, coords_2[j,1], coords_2[j,2], coords_2[j,3], coords_2[j,4]*/);\n//                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n//                                //this.ParseKML(url_href_2[j]);\n//\n//                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n//\n//                                    var kml_2 = [];\n//                                    kml_2 = result_2.getElementsByTagName(\"href\");\n//\n//                                    for (k=0; k<kml_2.length; k++){\n//                                        var url_href_3 = [];\n//                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'FXX' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n//                                        //console.log(url_href_3[k]);\n//\n//                                        var coords_3 = [];\n//                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n//                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n//                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n//                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n//\n//                                        //Next Level : Get the next KML actual position's coords\n//                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n//\n//                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n//\n//                                                var kml_3 = [];\n//                                                kml_3 = result_3.getElementsByTagName(\"href\");\n//\n//                                                for (l=0; l<kml_3.length; l++){\n//                                                    var url_href_4 = [];\n//                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'FXX' + \"/TREE/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../\", \"\");\n//                                                    //console.log(url_href_4[l]);\n//\n//                                                    var coords_4 = [];\n//                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n//                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n//                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n//                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n//\n//                                                    //Next Level : Get the KMZ actual position's coords\n//                                                    if (north < coords_4[l,1] && south > coords_4[l,2]  && east < coords_4[l,3] && west > coords_4[l,4]){\n//\n//                                                        Fetcher.xml(url_href_4[l]).then(function(result_4){\n//\n//                                                            var kml_4 = [];\n//                                                            kml_4 = result_4.getElementsByTagName(\"href\");\n//\n//                                                            //Get KMZ\n//                                                            for (m=0; m<kml_4.length; m++){\n//                                                                var url_href_kmz = [];\n//                                                                url_href_kmz[m] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'FXX/' + kml_4[m].childNodes[0].nodeValue.replace(\"../../\", \"\");\n//                                                                //console.log(url_href_kmz[m]);\n//\n//                                                                /*\n//                                                                var KMZLoader = new THREE.KMZLoader();\n//                                                                Fetcher.xml(KMZLoader.load(url_href_kmz[m])).then(function(result_5){\n//                                                                    console.log(result_5);\n//                                                                });*/\n//\n//                                                                //var col =  KMZLoader.parse(\"file/\" + KMZLoader.load(url_href_kmz[m]));\n//                                                                var kmz = [];\n//                                                                return this.KMZLoader.load(url_href_kmz[m]).then(function(result){\n//\n//                                                                        deferred.resolve(result);\n//                                                                        //return result;\n//                                                                }.bind(this));\n//\n//                                                                //var kmz += \"file/\" + kmz;\n//\n//                                                                //var kmz_2 = KMZLoader.parse(url_href_kmz[m]);\n//                                                                //console.log(kmz_2);\n//\n//                                                                //return kmz[m];\n//                                                            }\n//                                                            //console.log(url_href_kmz.length);\n//                                                        }.bind(this));\n//                                                    }\n//\n//                                                }\n//\n//                                            }.bind(this));\n//                                        }\n//                                    }\n//\n//                                }.bind(this));\n//                            }\n//\n//                        }\n//\n//                    }.bind(this));\n//\n//                }\n//            }\n//\n//        }.bind(this));\n//\n//        return deferred;\n//    };\n//\n//    return KML_Provider;\n//\n// });\n\n/*\n //If Guadeloupe\n                if (url_href_1[i] === 'http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/GLP/TREE/0/0_00_00.kml'){\n\n                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n                    {\n\n                        var kml_1 = [];\n                        kml_1 = result_1.getElementsByTagName(\"href\");\n                        //console.log(kml_1.length);\n\n                        for (j=0; j<kml_1.length; j++){\n\n                            var url_href_2 = [];\n                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GLP' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n                            //console.log(url_href_2[j]);\n\n                            //get tile's coords\n                            var coords_2 = [];\n                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n                            //console.log(coords_2[j,1] + coords_2[j,2] + coords_2[j,3] + coords_2[j,4]);\n\n                            //get min and max LodPixel of each tile\n                            //var min_max_2 = [];\n                            //min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n                            //min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n                            //console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);\n\n                            //Next level : Get the next KML actual position's coords\n                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n\n                                    var kml_2 = [];\n                                    kml_2 = result_2.getElementsByTagName(\"href\");\n\n                                    for (k=0; k<kml_2.length; k++){\n                                        var url_href_3 = [];\n                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GLP' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n                                        //console.log(url_href_3[k]);\n\n                                        var coords_3 = [];\n                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n\n                                        //Next Level : Get the next KML actual position's coords\n                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n\n                                                var kml_3 = [];\n                                                kml_3 = result_3.getElementsByTagName(\"href\");\n\n                                                for (l=0; l<kml_3.length; l++){\n                                                    var url_href_4 = [];\n                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GLP' + \"/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../../\", \"\");\n                                                    console.log(url_href_4[l]);\n\n                                                    var coords_4 = [];\n                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n\n                                                }\n\n                                            });\n                                        }\n                                    }\n\n                                });\n                            }\n\n                        }\n\n                    });\n\n                }\n\n                //If Guyane\n                if (url_href_1[i] === 'http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/GUF/TREE/0/0_00_00.kml'){\n\n                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n                    {\n\n                        var kml_1 = [];\n                        kml_1 = result_1.getElementsByTagName(\"href\");\n                        //console.log(kml_1.length);\n\n                        for (j=0; j<kml_1.length; j++){\n\n                            var url_href_2 = [];\n                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GUF' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n                            //console.log(url_href_2[j]);\n\n                            //get tile's coords\n                            var coords_2 = [];\n                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n                            //console.log(coords_2[j,1] + coords_2[j,2] + coords_2[j,3] + coords_2[j,4]);\n\n                            //get min and max LodPixel of each tile\n                            //var min_max_2 = [];\n                            //min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n                            //min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n                            //console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);\n\n                            //Next level : Get the next KML actual position's coords\n                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n\n                                    var kml_2 = [];\n                                    kml_2 = result_2.getElementsByTagName(\"href\");\n\n                                    for (k=0; k<kml_2.length; k++){\n                                        var url_href_3 = [];\n                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GUF' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n                                        //console.log(url_href_3[k]);\n\n                                        var coords_3 = [];\n                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n\n                                        //Next Level : Get the next KML actual position's coords\n                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n\n                                                var kml_3 = [];\n                                                kml_3 = result_3.getElementsByTagName(\"href\");\n\n                                                for (l=0; l<kml_3.length; l++){\n                                                    var url_href_4 = [];\n                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'GUF' + \"/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../../\", \"\");\n                                                    //console.log(url_href_4[l]);\n\n                                                    var coords_4 = [];\n                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n\n                                                }\n\n                                            });\n                                        }\n                                    }\n\n                                });\n                            }\n\n                        }\n\n                    });\n\n                }\n\n                //If Martinique\n                if (url_href_1[i] === 'http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/MTQ/TREE/0/0_00_00.kml'){\n\n                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n                    {\n\n                        var kml_1 = [];\n                        kml_1 = result_1.getElementsByTagName(\"href\");\n                        //console.log(kml_1.length);\n\n                        for (j=0; j<kml_1.length; j++){\n\n                            var url_href_2 = [];\n                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'MTQ' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n                            //console.log(url_href_2[j]);\n\n                            //get tile's coords\n                            var coords_2 = [];\n                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n                            //console.log(coords_2[j,1] + coords_2[j,2] + coords_2[j,3] + coords_2[j,4]);\n\n                            //get min and max LodPixel of each tile\n                            //var min_max_2 = [];\n                            //min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n                            //min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n                            //console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);\n\n                            //Next level : Get the next KML actual position's coords\n                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n\n                                    var kml_2 = [];\n                                    kml_2 = result_2.getElementsByTagName(\"href\");\n\n                                    for (k=0; k<kml_2.length; k++){\n                                        var url_href_3 = [];\n                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'MTQ' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n                                        //console.log(url_href_3[k]);\n\n                                        var coords_3 = [];\n                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n\n                                        //Next Level : Get the next KML actual position's coords\n                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n\n                                                var kml_3 = [];\n                                                kml_3 = result_3.getElementsByTagName(\"href\");\n\n                                                for (l=0; l<kml_3.length; l++){\n                                                    var url_href_4 = [];\n                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'MTQ' + \"/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../../\", \"\");\n                                                    //console.log(url_href_4[l]);\n\n                                                    var coords_4 = [];\n                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n\n                                                }\n\n                                            });\n                                        }\n                                    }\n\n                                });\n                            }\n\n                        }\n\n                    });\n\n                }\n\n                //If Réunion\n                if (url_href_1[i] === 'http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/REU/TREE/0/0_00_00.kml'){\n\n                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n                    {\n\n                        var kml_1 = [];\n                        kml_1 = result_1.getElementsByTagName(\"href\");\n                        //console.log(kml_1.length);\n\n                        for (j=0; j<kml_1.length; j++){\n\n                            var url_href_2 = [];\n                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'REU' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n                            //console.log(url_href_2[j]);\n\n                            //get tile's coords\n                            var coords_2 = [];\n                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n                            //console.log(coords_2[j,1] + coords_2[j,2] + coords_2[j,3] + coords_2[j,4]);\n\n                            //get min and max LodPixel of each tile\n                            //var min_max_2 = [];\n                            //min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n                            //min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n                            //console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);\n\n                            //Next level : Get the next KML actual position's coords\n                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n\n                                    var kml_2 = [];\n                                    kml_2 = result_2.getElementsByTagName(\"href\");\n\n                                    for (k=0; k<kml_2.length; k++){\n                                        var url_href_3 = [];\n                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'REU' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n                                        //console.log(url_href_3[k]);\n\n                                        var coords_3 = [];\n                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n\n                                        //Next Level : Get the next KML actual position's coords\n                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n\n                                                var kml_3 = [];\n                                                kml_3 = result_3.getElementsByTagName(\"href\");\n\n                                                for (l=0; l<kml_3.length; l++){\n                                                    var url_href_4 = [];\n                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'REU' + \"/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../../\", \"\");\n                                                    //console.log(url_href_4[l]);\n\n                                                    var coords_4 = [];\n                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n\n                                                }\n\n                                            });\n                                        }\n                                    }\n\n                                });\n                            }\n\n                        }\n\n                    });\n\n                }\n                //If Saint-Pierre et Miquelon\n                if (url_href_1[i] === 'http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/vecteurtuile3d/BATI3D/SPM/TREE/0/0_00_00.kml'){\n\n                    Fetcher.xml(url_href_1[i]).then(function(result_1)\n                    {\n\n                        var kml_1 = [];\n                        kml_1 = result_1.getElementsByTagName(\"href\");\n                        //console.log(kml_1.length);\n\n                        for (j=0; j<kml_1.length; j++){\n\n                            var url_href_2 = [];\n                            url_href_2[j] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'SPM' + \"/TREE/\" + kml_1[j].childNodes[0].nodeValue.replace(\"../\", \"\");\n                            //console.log(url_href_2[j]);\n\n                            //get tile's coords\n                            var coords_2 = [];\n                            coords_2[j,1] = result_1.getElementsByTagName(\"north\")[j].childNodes[0].nodeValue;\n                            coords_2[j,2] = result_1.getElementsByTagName(\"south\")[j].childNodes[0].nodeValue;\n                            coords_2[j,3] = result_1.getElementsByTagName(\"east\")[j].childNodes[0].nodeValue;\n                            coords_2[j,4] = result_1.getElementsByTagName(\"west\")[j].childNodes[0].nodeValue;\n                            //console.log(coords_2[j,1] + coords_2[j,2] + coords_2[j,3] + coords_2[j,4]);\n\n                            //get min and max LodPixel of each tile\n                            //var min_max_2 = [];\n                            //min_max_2[j,1] = result_1.getElementsByTagName(\"minLodPixels\")[j].childNodes[0].nodeValue;\n                            //min_max_2[j,2] = result_1.getElementsByTagName(\"maxLodPixels\")[j].childNodes[0].nodeValue;\n                            //console.log(\"minLodPixels = \" + min_max_2[j,1] + \"; maxLodPixels = \" + min_max_2[j,2]);\n\n                            //Next level : Get the next KML actual position's coords\n                            if (north < coords_2[j,1] && south > coords_2[j,2]  && east < coords_2[j,3] && west > coords_2[j,4]){\n                                Fetcher.xml(url_href_2[j]).then(function(result_2){\n\n                                    var kml_2 = [];\n                                    kml_2 = result_2.getElementsByTagName(\"href\");\n\n                                    for (k=0; k<kml_2.length; k++){\n                                        var url_href_3 = [];\n                                        url_href_3[k] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'SPM' + \"/TREE/\" + kml_2[k].childNodes[0].nodeValue.replace(\"../\", \"\");\n                                        //console.log(url_href_3[k]);\n\n                                        var coords_3 = [];\n                                        coords_3[k,1] = result_1.getElementsByTagName(\"north\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,2] = result_1.getElementsByTagName(\"south\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,3] = result_1.getElementsByTagName(\"east\")[k].childNodes[0].nodeValue;\n                                        coords_3[k,4] = result_1.getElementsByTagName(\"west\")[k].childNodes[0].nodeValue;\n\n                                        //Next Level : Get the next KML actual position's coords\n                                        if (north < coords_3[k,1] && south > coords_3[k,2]  && east < coords_3[k,3] && west > coords_3[k,4]){\n                                            Fetcher.xml(url_href_3[k]).then(function(result_3){\n\n                                                var kml_3 = [];\n                                                kml_3 = result_3.getElementsByTagName(\"href\");\n\n                                                for (l=0; l<kml_3.length; l++){\n                                                    var url_href_4 = [];\n                                                    url_href_4[l] = 'http://wxs.ign.fr/' + key + '/vecteurtuile3d/BATI3D/' + 'SPM' + \"/\" + kml_3[l].childNodes[0].nodeValue.replace(\"../../\", \"\");\n                                                    //console.log(url_href_4[l]);\n\n                                                    var coords_4 = [];\n                                                    coords_4[l,1] = result_1.getElementsByTagName(\"north\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,2] = result_1.getElementsByTagName(\"south\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,3] = result_1.getElementsByTagName(\"east\")[l].childNodes[0].nodeValue;\n                                                    coords_4[l,4] = result_1.getElementsByTagName(\"west\")[l].childNodes[0].nodeValue;\n\n                                                }\n\n                                            });\n                                        }\n                                    }\n\n                                });\n                            }\n\n                        }\n\n                    });\n\n                }\n\n\n */\n"]}