{"version":3,"sources":["../../src/Renderer/c3DEngine.js"],"names":["THREE","c3DEngine","rendererOrDiv","options","NOIE","isInternetExplorer","antialias","undefined","alpha","logarithmicDepthBuffer","gLDebug","renderer","domElement","viewerDiv","width","clientWidth","height","clientHeight","positionBuffer","_nextThreejsLayer","fullSizeRenderTarget","WebGLRenderTarget","texture","minFilter","LinearFilter","generateMipmaps","renderView","view","setViewport","clear","render","scene","camera","camera3D","bind","onWindowResize","w","h","setSize","WebGLRenderer","canvas","document","createElement","ex","console","error","element","id","style","fontFamily","fontSize","fontWeight","textAlign","background","color","padding","margin","innerHTML","window","WebGLRenderingContext","join","appendChild","Error","tabIndex","updateCapabilities","setClearColor","autoClear","sortObjects","setPixelRatio","devicePixelRatio","prototype","getWindowSize","Vector2","getRenderer","renderViewTobuffer","buffer","x","y","current","getRenderTarget","setRenderTarget","setScissor","setScissorTest","clearTarget","pixelBuffer","Uint8Array","readRenderTargetPixels","bufferToImage","ctx","getContext","imgData","getImageData","data","set","putImageData","image","Image","src","toDataURL","getUniqueThreejsLayer","warn","result","depthRGBA","Vector4","depthBufferRGBAValueToOrthoZ","depthBufferRGBA","fromArray","divideScalar","isLogDepthBufferSupported","gl_FragDepthEXT","logDepthBufFC","Math","log","far","LN2","pow","gl_FragCoord_Z","near"],"mappings":"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","file":"c3DEngine.js","sourcesContent":["/**\n * Generated On: 2015-10-5\n * Class: c3DEngine\n * Description: 3DEngine est l'interface avec le framework webGL.\n */\n\n/* global Uint8Array, Float64Array, document, window, Image */\n\nimport * as THREE from 'three';\nimport Capabilities from '../Core/System/Capabilities';\nimport { unpack1K } from './LayeredMaterial';\n\nfunction c3DEngine(rendererOrDiv, options = {}) {\n    const NOIE = !Capabilities.isInternetExplorer();\n    // pick sensible default options\n    if (options.antialias === undefined) {\n        options.antialias = true;\n    }\n    if (options.alpha === undefined) {\n        options.alpha = true;\n    }\n    if (options.logarithmicDepthBuffer === undefined) {\n        options.logarithmicDepthBuffer = this.gLDebug || NOIE;\n    }\n\n    const renderer = rendererOrDiv.domElement ? rendererOrDiv : undefined;\n    const viewerDiv = renderer ? undefined : rendererOrDiv;\n\n    this.width = (renderer ? renderer.domElement : viewerDiv).clientWidth;\n    this.height = (renderer ? renderer.domElement : viewerDiv).clientHeight;\n\n    this.positionBuffer = null;\n    this._nextThreejsLayer = 1;\n\n    this.fullSizeRenderTarget = new THREE.WebGLRenderTarget(this.width, this.height);\n    this.fullSizeRenderTarget.texture.minFilter = THREE.LinearFilter;\n    this.fullSizeRenderTarget.texture.generateMipmaps = false;\n\n    this.renderView = function renderScene(view) {\n        this.renderer.setViewport(0, 0, this.width, this.height);\n        this.renderer.clear();\n        this.renderer.render(view.scene, view.camera.camera3D);\n    }.bind(this);\n\n    this.onWindowResize = function onWindowResize(w, h) {\n        this.width = w;\n        this.height = h;\n        this.fullSizeRenderTarget.setSize(this.width, this.height);\n        this.renderer.setSize(this.width, this.height);\n    }.bind(this);\n\n    // Create renderer\n    try {\n        this.renderer = renderer || new THREE.WebGLRenderer({\n            canvas: document.createElement('canvas'),\n            antialias: options.antialias,\n            alpha: options.alpha,\n            logarithmicDepthBuffer: options.logarithmicDepthBuffer,\n        });\n    } catch (ex) {\n        // eslint-disable-next-line no-console\n        console.error('Failed to create WebGLRenderer', ex);\n        this.renderer = null;\n    }\n\n    if (!this.renderer) {\n        // from Detector.js\n        const element = document.createElement('div');\n        element.id = 'webgl-error-message';\n        element.style.fontFamily = 'monospace';\n        element.style.fontSize = '13px';\n        element.style.fontWeight = 'normal';\n        element.style.textAlign = 'center';\n        element.style.background = '#fff';\n        element.style.color = '#000';\n        element.style.padding = '1.5em';\n        element.style.width = '400px';\n        element.style.margin = '5em auto 0';\n        element.innerHTML = window.WebGLRenderingContext ? [\n            'Your graphics card does not seem to support <a href=\"http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation\" style=\"color:#000\">WebGL</a>.<br />',\n            'Find out how to get it <a href=\"http://get.webgl.org/\" style=\"color:#000\">here</a>.<br>',\n            'See also <a href=\"https://www.khronos.org/webgl/wiki/BlacklistsAndWhitelists\">graphics card blacklisting</a>',\n        ].join('\\n') : [\n            'Your browser does not seem to support <a href=\"http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation\" style=\"color:#000\">WebGL</a>.<br/>',\n            'Find out how to get it <a href=\"http://get.webgl.org/\" style=\"color:#000\">here</a>.<br>',\n            'You can also try another browser like Firefox or Chrome.',\n        ].join('\\n');\n        viewerDiv.appendChild(element);\n        throw new Error('WebGL unsupported');\n    }\n\n    // Let's allow our canvas to take focus\n    // The condition below looks weird, but it's correct: querying tabIndex\n    // returns -1 if not set, but we still need to explicitly set it to force\n    // the tabindex focus flag to true (see\n    // https://www.w3.org/TR/html5/editing.html#specially-focusable)\n    if (this.renderer.domElement.tabIndex === -1) {\n        this.renderer.domElement.tabIndex = -1;\n    }\n\n    Capabilities.updateCapabilities(this.renderer);\n\n    this.renderer.setClearColor(0x030508);\n    this.renderer.autoClear = false;\n    this.renderer.sortObjects = false;\n\n    if (!renderer) {\n        this.renderer.setPixelRatio(viewerDiv.devicePixelRatio);\n        this.renderer.setSize(viewerDiv.clientWidth, viewerDiv.clientHeight);\n        viewerDiv.appendChild(this.renderer.domElement);\n    }\n}\n\n/*\n * return\n */\nc3DEngine.prototype.getWindowSize = function getWindowSize() {\n    return new THREE.Vector2(this.width, this.height);\n};\n\n/**\n * return renderer THREE.js\n * @returns {undefined|c3DEngine_L7.THREE.WebGLRenderer}\n */\nc3DEngine.prototype.getRenderer = function getRenderer() {\n    return this.renderer;\n};\n\nc3DEngine.prototype.renderViewTobuffer = function renderViewTobuffer(view, buffer, x, y, width, height) {\n    // TODO Deallocate render texture\n    const current = this.renderer.getRenderTarget();\n    this.renderer.setRenderTarget(buffer);\n    this.renderer.setViewport(0, 0, buffer.width, buffer.height);\n    this.renderer.setScissor(x, y, width, height);\n    this.renderer.setScissorTest(true);\n    this.renderer.clearTarget(buffer, true, true, false);\n    this.renderer.render(view.scene, view.camera.camera3D, buffer);\n    this.renderer.setScissorTest(false);\n    var pixelBuffer = new Uint8Array(4 * width * height);\n    this.renderer.readRenderTargetPixels(buffer, x, y, width, height, pixelBuffer);\n    this.renderer.setRenderTarget(current);\n\n    return pixelBuffer;\n};\n\nc3DEngine.prototype.bufferToImage = function bufferToImage(pixelBuffer, width, height) {\n    var canvas = document.createElement('canvas');\n    var ctx = canvas.getContext('2d');\n\n    // size the canvas to your desired image\n    canvas.width = width;\n    canvas.height = height;\n\n    var imgData = ctx.getImageData(0, 0, width, height);\n    imgData.data.set(pixelBuffer);\n\n    ctx.putImageData(imgData, 0, 0);\n\n    // create a new img object\n    var image = new Image();\n\n    // set the img.src to the canvas data url\n    image.src = canvas.toDataURL();\n\n    return image;\n};\n\nc3DEngine.prototype.getUniqueThreejsLayer = function getUniqueThreejsLayer() {\n    // We use three.js Object3D.layers feature to manage visibility of\n    // geometry layers; so we need an internal counter to assign a new\n    // one to each new geometry layer.\n    // Warning: only 32 ([0, 31]) different layers can exist.\n    if (this._nextThreejsLayer > 31) {\n        // eslint-disable-next-line no-console\n        console.warn('Too much three.js layers. Starting from now all of them will use layerMask = 31');\n        this._nextThreejsLayer = 31;\n    }\n\n    const result = this._nextThreejsLayer++;\n\n    return result;\n};\n\nconst depthRGBA = new THREE.Vector4();\nc3DEngine.prototype.depthBufferRGBAValueToOrthoZ = function depthBufferRGBAValueToOrthoZ(depthBufferRGBA, camera) {\n    depthRGBA.fromArray(depthBufferRGBA).divideScalar(255.0);\n\n    if (Capabilities.isLogDepthBufferSupported()) {\n        const gl_FragDepthEXT = unpack1K(depthRGBA);\n        const logDepthBufFC = 2.0 / (Math.log(camera.far + 1.0) / Math.LN2);\n        // invert function : gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n        return Math.pow(2.0, 2.0 * gl_FragDepthEXT / logDepthBufFC);\n    } else {\n        let gl_FragCoord_Z = unpack1K(depthRGBA);\n        gl_FragCoord_Z = gl_FragCoord_Z * 2.0 - 1.0;\n        return 2.0 * camera.near * camera.far / (camera.far + camera.near - gl_FragCoord_Z * (camera.far - camera.near));\n    }\n};\n\n\nexport default c3DEngine;\n"]}