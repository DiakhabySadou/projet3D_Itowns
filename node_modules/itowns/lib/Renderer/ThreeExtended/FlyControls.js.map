{"version":3,"sources":["../../../src/Renderer/ThreeExtended/FlyControls.js"],"names":["THREE","MOVEMENTS","method","sign","noSpeed","wheelup","oneshot","wheeldown","onDocumentMouseDown","event","preventDefault","_isMouseDown","_onMouseDownMouseX","clientX","_onMouseDownMouseY","clientY","onTouchStart","touches","pageX","pageY","onPointerMove","pointerX","pointerY","pxToAngleRatio","Math","degToRad","_camera3D","fov","view","mainLoop","gfxEngine","height","rotateY","rotateX","notifyChange","onDocumentMouseUp","onKeyUp","e","move","keyCode","moves","delete","onKeyDown","add","onDocumentMouseWheel","delta","wheelDelta","undefined","detail","FlyControls","options","domElement","renderer","camera","camera3D","moveSpeed","addEventListener","bind","bindedPM","addFrameRequester","focusOnMouseOver","focus","focusOnClick","size","dt","updateLoopRestarted","EventDispatcher"],"mappings":"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","file":"FlyControls.js","sourcesContent":["import * as THREE from 'three';\n\nconst MOVEMENTS = {\n    38: { method: 'translateZ', sign: -1 }, // FORWARD: up key\n    40: { method: 'translateZ', sign: 1 }, // BACKWARD: down key\n    37: { method: 'translateX', sign: -1 }, // STRAFE_LEFT: left key\n    39: { method: 'translateX', sign: 1 }, // STRAFE_RIGHT: right key\n    33: { method: 'rotateZ', sign: 1, noSpeed: true }, // UP: PageUp key\n    34: { method: 'rotateZ', sign: -1, noSpeed: true }, // DOWN: PageDown key\n    wheelup: { method: 'translateZ', sign: 1, oneshot: true }, // WHEEL up\n    wheeldown: { method: 'translateZ', sign: -1, oneshot: true }, // WHEEL down\n};\n\nfunction onDocumentMouseDown(event) {\n    event.preventDefault();\n    this._isMouseDown = true;\n\n    this._onMouseDownMouseX = event.clientX;\n    this._onMouseDownMouseY = event.clientY;\n}\n\nfunction onTouchStart(event) {\n    event.preventDefault();\n    this._isMouseDown = true;\n\n    this._onMouseDownMouseX = event.touches[0].pageX;\n    this._onMouseDownMouseY = event.touches[0].pageY;\n}\n\n\nfunction onPointerMove(pointerX, pointerY) {\n    if (this._isMouseDown === true) {\n        // in rigor we have tan(theta) = tan(cameraFOV) * deltaH / H\n        // (where deltaH is the vertical amount we moved, and H the renderer height)\n        // we loosely approximate tan(x) by x\n        const pxToAngleRatio = THREE.Math.degToRad(this._camera3D.fov) / this.view.mainLoop.gfxEngine.height;\n        this._camera3D.rotateY((pointerX - this._onMouseDownMouseX) * pxToAngleRatio);\n        this._camera3D.rotateX((pointerY - this._onMouseDownMouseY) * pxToAngleRatio);\n        this._onMouseDownMouseX = pointerX;\n        this._onMouseDownMouseY = pointerY;\n        this.view.notifyChange(false, this._camera3D);\n    }\n}\n\nfunction onDocumentMouseUp() {\n    this._isMouseDown = false;\n}\n\nfunction onKeyUp(e) {\n    const move = MOVEMENTS[e.keyCode];\n    if (move) {\n        this.moves.delete(move);\n        e.preventDefault();\n    }\n}\n\nfunction onKeyDown(e) {\n    const move = MOVEMENTS[e.keyCode];\n    if (move) {\n        this.moves.add(move);\n        this.view.notifyChange(false, this);\n        e.preventDefault();\n    }\n}\n\nfunction onDocumentMouseWheel(event) {\n    let delta = 0;\n    if (event.wheelDelta !== undefined) {\n        delta = event.wheelDelta;\n    // Firefox\n    } else if (event.detail !== undefined) {\n        delta = -event.detail;\n    }\n    if (delta < 0) {\n        this.moves.add(MOVEMENTS.wheelup);\n    } else {\n        this.moves.add(MOVEMENTS.wheeldown);\n    }\n\n    this.view.notifyChange(false, this);\n}\n\n/**\n * First-Person controls (at least a possible declination of it).\n *\n * Bindings:\n * - up + down keys: forward/backward\n * - left + right keys: strafing movements\n * - PageUp + PageDown: roll movement\n * - mouse click+drag: pitch and yaw movements (as looking at a panorama, not as in FPS games for instance)\n */\nclass FlyControls extends THREE.EventDispatcher {\n\n    /**\n     * @Constructor\n     * @param {View} view\n     * @param {object} options\n     * @param {boolean} options.focusOnClick - whether or not to focus the renderer domElement on click\n     * @param {boolean} options.focusOnMouseOver - whether or not to focus when the mouse is over the domElement\n     */\n    constructor(view, options = {}) {\n        super();\n        const domElement = view.mainLoop.gfxEngine.renderer.domElement;\n        this.view = view;\n        this.options = options;\n        this._camera3D = view.camera.camera3D;\n        this.moves = new Set();\n        this.moveSpeed = 10; // backward or forward move speed in m/s\n\n        this._onMouseDownMouseX = 0;\n        this._onMouseDownMouseY = 0;\n\n        this._isMouseDown = false;\n\n        domElement.addEventListener('mousedown', onDocumentMouseDown.bind(this), false);\n        domElement.addEventListener('touchstart', onTouchStart.bind(this), false);\n        const bindedPM = onPointerMove.bind(this);\n        domElement.addEventListener('mousemove', e => bindedPM(e.clientX, e.clientY), false);\n        domElement.addEventListener('touchmove', e => bindedPM(e.touches[0].pageX, e.touches[0].pageY), false);\n        domElement.addEventListener('mouseup', onDocumentMouseUp.bind(this), false);\n        domElement.addEventListener('touchend', onDocumentMouseUp.bind(this), false);\n        domElement.addEventListener('mousewheel', onDocumentMouseWheel.bind(this), false);\n        domElement.addEventListener('DOMMouseScroll', onDocumentMouseWheel.bind(this), false); // firefox\n        domElement.addEventListener('keyup', onKeyUp.bind(this), true);\n        domElement.addEventListener('keydown', onKeyDown.bind(this), true);\n\n        this.view.addFrameRequester(this);\n\n        // focus policy\n        if (options.focusOnMouseOver) {\n            domElement.addEventListener('mouseover', () => domElement.focus());\n        }\n        if (options.focusOnClick) {\n            domElement.addEventListener('click', () => domElement.focus());\n        }\n    }\n\n    isUserInteracting() {\n        return this.moves.size !== 0 || this._isMouseDown;\n    }\n\n    update(dt, updateLoopRestarted) {\n        // if we are in a keypressed state, then update position\n\n        // dt will not be relevant when we just started rendering, we consider a 1-frame move in this case\n        if (updateLoopRestarted) {\n            dt = 16;\n        }\n\n        for (const move of this.moves) {\n            this._camera3D[move.method](move.sign * (move.noSpeed ? 1 : this.moveSpeed) * dt / 1000);\n        }\n\n        if (this.moves.size > 0 || this._isMouseDown) {\n            this.view.notifyChange(true, this._camera3D);\n\n            for (const move of this.moves) {\n                if (move.oneshot) {\n                    this.moves.delete(move);\n                }\n            }\n        }\n    }\n}\n\nexport default FlyControls;\n"]}